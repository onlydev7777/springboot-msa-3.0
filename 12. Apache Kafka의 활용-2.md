# Apache Kafka 활용-2

## 데이터 동기화 order-service -> catalog-service

- order-service 에 요청된 주문 수량 정보를 catalog-service 에 반영
- order-service 에서 Kafka Topic 으로 메세지 전송

  **-> Producer**

- catalog-service 에서 Kafka Topic에 전송된 메세지 수신

  **-> Consumer**

![microservice 간 데이터 동기화.png](img/section12/microservice%20간%20데이터%20동기화.png)

## catalog-service

#### KafkaConsumer 구현
```java
@KafkaListener(topics = "example-catalog-topic")  // example-catalog-topic 토픽 리스닝
```

```java
@Slf4j
@RequiredArgsConstructor
@Service
public class KafkaConsumer {

  private final CatalogRepository repository;
  private final ObjectMapper objectMapper;

  @KafkaListener(topics = "example-catalog-topic")
  @Transactional
  public void updateQty(String kafkaMessage) throws JsonProcessingException {
    log.info("Kafka Message : " + kafkaMessage);

    Map<String, Object> map = objectMapper.readValue(kafkaMessage, Map.class);

    Catalog catalog = repository.findByProductId((String) map.get("productId"))
        .orElseThrow();

    catalog.decreaseStock((Integer) map.get("qty"));
  }
}

```

***
## order-service

#### KafkaProducer 구현

example-catalog-topic 토픽으로 메세지 전송

```java
@Slf4j
@RequiredArgsConstructor
@Service
public class KafkaProducer {

  private final ObjectMapper objectMapper;
  private final KafkaTemplate<String, String> kafkaTemplate;

  public OrderDto send(String topic, OrderDto orderDto) throws JsonProcessingException {
    String jsonString = objectMapper.writeValueAsString(orderDto);
    kafkaTemplate.send(topic, jsonString);
    log.info("Kafka Producer sent data from the Order microservice : " + jsonString);

    return orderDto;
  }
}

```

```java
  @PostMapping("/{userId}/orders")
  public ResponseEntity<OrderResponse> createOrder(@PathVariable String userId,
      @RequestBody OrderRequest request) throws JsonProcessingException {

    OrderDto dto = mapper.toDto(request);
    dto.setUserId(userId);
    dto.setTotalPrice(dto.getQty() * dto.getUnitPrice());
    dto.setCreatedAt(LocalDate.now());
    dto.setOrderId(UUID.randomUUID().toString());
//    dto = service.createOrder(dto);

    //send kafka
    kafkaProducer.send("example-catalog-topic", dto);
    orderProducer.send("orders", dto);

    return ResponseEntity.status(HttpStatus.CREATED)
        .body(mapper.toResponse(dto));
  }
```

## Postman 테스트

